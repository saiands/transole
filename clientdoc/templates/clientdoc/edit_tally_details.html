{% extends 'clientdoc/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="row">
    <div class="col-12">
        {% include 'clientdoc/includes/workflow_steps.html' with current_step=1 progress_percentage=25 %}
    </div>
</div>

<div class="container-fluid py-4" style="max-width: 1400px;">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-0"><i class="bi bi-pencil-square me-2"></i>Edit Invoice Details</h2>
            <p class="text-muted mb-0">Update Tally invoicing details and additional notes.</p>
        </div>
        <div>
            <!-- Print Button as requested -->
            <a href="{% url 'clientdoc:print_invoice' invoice_id=form.instance.id %}" target="_blank"
                class="btn btn-dark shadow-sm me-2">
                <i class="bi bi-printer me-2"></i>Print Invoice
            </a>
            <a href="{% url 'clientdoc:invoice_list' %}" class="btn btn-light border"><i
                    class="bi bi-arrow-left me-1"></i> Back to List</a>
        </div>
    </div>

    <!-- Messages handled by base.html -->

    <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
        <div class="card-header bg-primary text-white py-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">Invoice Header & Terms</h5>
                <span class="badge bg-white text-primary rounded-pill px-3">Invoice #{{
                    invoice.tally_invoice_number|default:invoice.app_invoice_number }}</span>
            </div>
        </div>

        <div class="card-body p-5 bg-white">
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}

                <!-- Layout utilizing Crispy Forms if available, or manual nice layout -->
                <!-- We will use manual layout for maximum control over "Modern Arrangement" -->

                <div class="row g-4 mb-4">
                    <!-- Section 1: Core Details -->
                    <div class="col-md-12">
                        <h6 class="text-uppercase text-secondary fw-bold small mb-3 border-bottom pb-2">Core Info</h6>
                        <div class="row g-3">
                            <div class="col-md-6 col-xl-3">
                                {{ form.buyer|as_crispy_field }}
                            </div>
                            <div class="col-md-6 col-xl-3">
                                {{ form.location|as_crispy_field }}
                            </div>
                            <div class="col-md-6 col-xl-3">
                                {{ form.date|as_crispy_field }}
                            </div>
                            <div class="col-md-6 col-xl-3">
                                {{ form.tally_invoice_number|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Remarks (Requested) -->
                    <div class="col-md-12">
                        <h6 class="text-uppercase text-secondary fw-bold small mb-3 border-bottom pb-2 mt-2">Remarks &
                            Notes</h6>
                        <div class="row">
                            <div class="col-md-12">
                                {{ form.remark|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Delivery Details -->
                    <div class="col-md-12">
                        <h6 class="text-uppercase text-secondary fw-bold small mb-3 border-bottom pb-2 mt-2">Delivery &
                            Order Details</h6>
                        <div class="row g-3">
                            <div class="col-md-3">
                                {{ form.buyers_order_no|as_crispy_field }}
                            </div>
                            <div class="col-md-3">
                                {{ form.buyers_order_date|as_crispy_field }}
                            </div>
                            <div class="col-md-3">
                                {{ form.dispatch_doc_no|as_crispy_field }}
                            </div>
                            <div class="col-md-3">
                                {{ form.delivery_note_date|as_crispy_field }}
                            </div>

                            <div class="col-md-3">
                                {{ form.delivery_note|as_crispy_field }}
                            </div>
                            <div class="col-md-3">
                                {{ form.mode_terms_payment|as_crispy_field }}
                            </div>
                            <div class="col-md-3">
                                {{ form.other_references|as_crispy_field }}
                            </div>
                            <div class="col-md-3">
                                {{ form.reference_no_date|as_crispy_field }}
                            </div>

                            <div class="col-md-4">
                                {{ form.dispatched_through|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.destination|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <h6 class="text-uppercase text-secondary fw-bold small mb-3 border-bottom pb-2 mt-2">Terms of
                            Delivery</h6>
                        {{ form.terms_of_delivery|as_crispy_field }}
                        <!-- ITEM TABLE SECTION -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-uppercase text-secondary fw-bold small mb-3 border-bottom pb-2 mt-4">
                                    Invoice Items</h6>
                                <div class="card border-0 shadow-sm">
                                    <div
                                        class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                                        <h5 class="fw-bold text-dark mb-0"><i
                                                class="bi bi-box-seam me-2 text-primary"></i>Items</h5>
                                        <button type="button" class="btn btn-primary rounded-pill px-4 btn-sm"
                                            id="add-item-btn">
                                            <i class="bi bi-plus-lg me-1"></i> Add Row
                                        </button>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover mb-0 align-middle" id="item-table"
                                                style="min-width: 1200px;">
                                                <thead class="bg-light text-secondary text-uppercase small">
                                                    <tr>
                                                        <th style="width: 20%; padding: 12px 16px;">Item Name</th>
                                                        <th style="width: 10%; padding: 12px;">GST %</th>
                                                        <th style="width: 8%; padding: 12px;">Qty Ship</th>
                                                        <th style="width: 8%; padding: 12px;">Qty Bill</th>
                                                        <th style="width: 6%; padding: 12px;">Unit</th>
                                                        <th style="width: 10%; padding: 12px;">Rate (₹)</th>
                                                        <th style="width: 10%; padding: 12px;">Disc Type</th>
                                                        <th style="width: 10%; padding: 12px;">Disc Val</th>
                                                        <th style="width: 13%; padding: 12px;" class="text-end">Amount
                                                            (₹)</th>
                                                        <th style="width: 5%; padding: 12px;"></th>
                                                    </tr>
                                                </thead>
                                                <tbody class="border-top-0">
                                                    <!-- Rows added via JS -->
                                                    {{ formset.management_form }}
                                                    {% for form in formset %}
                                                    {{ form.id }} <!-- Hidden ID for updates -->
                                                    <tr class="item-row align-middle">
                                                        <td style="padding:10px;">
                                                            <select name="{{ form.prefix }}-item"
                                                                class="form-select item-select shadow-none border-secondary-subtle">
                                                                <option value="">Select Item...</option>
                                                                {% for item in items %}
                                                                <option value="{{ item.id }}" {% if
                                                                    form.instance.item_id==item.id %}selected{% endif
                                                                    %}>{{ item.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                        <td style="padding:10px;">{{ form.gst_rate }}</td>
                                                        <td style="padding:10px;">{{ form.quantity_shipped }}</td>
                                                        <td style="padding:10px;">{{ form.quantity_billed }}</td>
                                                        <td class="text-center text-muted small unit-display">-</td>
                                                        <td style="padding:10px;">{{ form.price }}</td>
                                                        <td style="padding:10px;">{{ form.discount_type }}</td>
                                                        <td style="padding:10px;">{{ form.discount_value }}</td>
                                                        <td class="text-end fw-bold text-dark amount-display h5 mb-0"
                                                            style="vertical-align: middle;">0.00</td>
                                                        <td class="text-center">
                                                            <div class="form-check d-none">{{ form.DELETE }}</div>
                                                            <!-- Hidden Delete Checkbox -->
                                                            <button type="button"
                                                                class="btn btn-outline-danger border-0 remove-item-btn"><i
                                                                    class="bi bi-trash"></i></button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                                <tfoot class="table-group-divider bg-light fw-bold">
                                                    <!-- Footers same as create -->
                                                    <tr>
                                                        <td colspan="3"
                                                            class="text-end text-muted small text-uppercase pt-3">Total
                                                            Qty (Billed)</td>
                                                        <td class="pt-3" style="padding-left:12px;"><span
                                                                id="total-qty-billed">0</span></td>
                                                        <td colspan="4"
                                                            class="text-end text-muted small text-uppercase pt-3">Total
                                                            Taxable</td>
                                                        <td class="text-end pt-3 text-primary" id="total-taxable"
                                                            style="padding-right:12px;">0.00</td>
                                                        <td></td>
                                                    </tr>
                                                    <tr class="bg-primary-subtle border-top border-primary">
                                                        <td colspan="8"
                                                            class="text-end text-uppercase text-primary pt-4 pb-4"
                                                            style="font-size: 1.1rem;">Grand Total</td>
                                                        <td class="text-end pt-4 pb-4 fw-bold text-primary"
                                                            style="font-size: 1.3rem; padding-right:12px;"
                                                            id="grand-total">0.00</td>
                                                        <td></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ITEM DATA SCRIPT -->
                        <script id="items-data" type="application/json">
    [
        {% for item in items %}
        {
            "id": "{{ item.id }}",
            "name": "{{ item.name|escapejs }}",
            "price": {{ item.price }},
            "gst_rate": {{ item.gst_rate }},
            "unit": "{{ item.unit|default:'Nos'|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
    </script>
                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                // Parse items data
                                const itemsDataEl = document.getElementById('items-data');
                                if (!itemsDataEl) return;
                                const availableItems = JSON.parse(itemsDataEl.textContent);

                                // HARDCODED PREFIX TO MATCH BACKEND
                                const formPrefix = 'invoiceitem_set';
                                const totalFormsInput = document.getElementById(`id_${formPrefix}-TOTAL_FORMS`);

                                const itemTableBody = document.querySelector('#item-table tbody');
                                const addItemBtn = document.getElementById('add-item-btn');

                                const totalQtyBilledEl = document.getElementById('total-qty-billed');
                                const totalTaxableEl = document.getElementById('total-taxable');
                                const grandTotalEl = document.getElementById('grand-total');

                                function calculateTotals() {
                                    let totalQty = 0;
                                    let totalTaxable = 0;
                                    let totalGst = 0;

                                    document.querySelectorAll('.item-row').forEach(row => {
                                        // Ignore hidden deleted rows
                                        const deleteInput = row.querySelector('input[name$="-DELETE"]');
                                        if (deleteInput && deleteInput.checked) {
                                            row.style.display = 'none';
                                            return;
                                        }

                                        const getVal = (suffix) => {
                                            let el = row.querySelector(`[name$="-${suffix}"]`);
                                            return el ? (parseFloat(el.value) || 0) : 0;
                                        };

                                        const qty = getVal('quantity_billed');
                                        const rate = getVal('price');
                                        const gstRate = getVal('gst_rate');
                                        const discVal = getVal('discount_value');

                                        const discTypeEl = row.querySelector(`[name$="-discount_type"]`);
                                        const discType = discTypeEl ? discTypeEl.value : 'Percentage';

                                        let gross = qty * rate;
                                        let discount = 0;
                                        if (discType === 'Percentage') discount = gross * (discVal / 100);
                                        else discount = discVal;

                                        let taxable = Math.max(0, gross - discount);
                                        let gstAmt = taxable * gstRate;

                                        const amountDisplay = row.querySelector('.amount-display');
                                        if (amountDisplay) amountDisplay.textContent = taxable.toFixed(2);

                                        totalQty += qty;
                                        totalTaxable += taxable;
                                        totalGst += gstAmt;
                                    });

                                    if (totalQtyBilledEl) totalQtyBilledEl.textContent = totalQty;
                                    if (totalTaxableEl) totalTaxableEl.textContent = totalTaxable.toFixed(2);
                                    if (grandTotalEl) grandTotalEl.textContent = (totalTaxable + totalGst).toFixed(2);
                                }

                                function addItemRow() {
                                    if (!totalFormsInput) return;
                                    const formIdx = parseInt(totalFormsInput.value);
                                    const row = itemTableBody.insertRow();
                                    row.className = 'item-row align-middle';

                                    const currentPrefix = `${formPrefix}-${formIdx}`;

                                    row.innerHTML = `
                <td style="padding:10px;">
                    <select name="${currentPrefix}-item" class="form-select item-select shadow-none border-secondary-subtle">
                        <option value="">Select Item...</option>
                        ${availableItems.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}
                    </select>
                </td>
                <td style="padding:10px;"><select name="${currentPrefix}-gst_rate" class="form-select"><option value="0.18">18%</option><option value="0.05">5%</option><option value="0.12">12%</option><option value="0.28">28%</option></select></td>
                <td style="padding:10px;"><input type="number" name="${currentPrefix}-quantity_shipped" value="0" class="form-control text-center"></td>
                <td style="padding:10px;"><input type="number" name="${currentPrefix}-quantity_billed" value="1" class="form-control text-center fw-bold"></td>
                <td class="text-center text-muted small unit-display">-</td>
                <td style="padding:10px;"><input type="number" step="0.01" name="${currentPrefix}-price" value="0.00" class="form-control"></td>
                <td style="padding:10px;"><select name="${currentPrefix}-discount_type" class="form-select"><option value="Percentage">%</option><option value="Amount">₹</option></select></td>
                <td style="padding:10px;"><input type="number" step="0.01" name="${currentPrefix}-discount_value" value="0.00" class="form-control"></td>
                <td class="text-end fw-bold text-dark amount-display h5 mb-0" style="vertical-align: middle;">0.00</td>
                <td class="text-center">
                    <button type="button" class="btn btn-outline-danger border-0 remove-item-btn"><i class="bi bi-trash"></i></button>
                    <input type="checkbox" name="${currentPrefix}-DELETE" class="d-none">
                </td>
            `;

                                    attachRowEvents(row);
                                    totalFormsInput.value = formIdx + 1;
                                }

                                function attachRowEvents(row) {
                                    const select = row.querySelector('.item-select');
                                    if (select) {
                                        select.addEventListener('change', () => {
                                            const item = availableItems.find(i => i.id == select.value);
                                            if (item) {
                                                const rateInput = row.querySelector('input[name$="-price"]');
                                                if (rateInput) rateInput.value = item.price.toFixed(2);
                                                const unitEl = row.querySelector('.unit-display');
                                                if (unitEl) unitEl.textContent = item.unit;
                                            }
                                            calculateTotals();
                                        });
                                    }

                                    row.querySelectorAll('input, select').forEach(el => {
                                        el.addEventListener('input', calculateTotals);
                                        el.addEventListener('change', calculateTotals);
                                    });

                                    const delBtn = row.querySelector('.remove-item-btn');
                                    if (delBtn) {
                                        delBtn.addEventListener('click', () => {
                                            const delBox = row.querySelector('input[name$="-DELETE"]');
                                            if (delBox) {
                                                delBox.checked = true;
                                                row.style.display = 'none';
                                            } else {
                                                row.remove();
                                                // Note: We don't decrement TOTAL_FORMS, just leave gaps.
                                            }
                                            calculateTotals();
                                        });
                                    }
                                }

                                document.querySelectorAll('.item-row').forEach(attachRowEvents);
                                if (addItemBtn) addItemBtn.addEventListener('click', addItemRow);

                                calculateTotals();
                            });
                        </script>
                        <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top">
                            <div class="text-muted small">
                                Verify all details before finalizing.
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" name="action" value="save_continue"
                                    class="btn btn-primary btn-lg px-4 rounded-pill shadow">
                                    Save & Continue <i class="bi bi-chevron-right ms-1"></i>
                                </button>
                                <button type="submit" name="action" value="save_only"
                                    class="btn btn-outline-primary btn-lg px-4 rounded-pill">
                                    Save
                                </button>
                            </div>
                        </div>
            </form>
        </div>

        <!-- Bottom Action Bar (Requested) -->
        <div class="card-footer bg-light py-3 px-5 d-flex justify-content-center">
            <a href="{% url 'clientdoc:print_invoice' invoice_id=form.instance.id %}" target="_blank"
                class="btn btn-dark shadow-sm w-50">
                <i class="bi bi-printer me-2"></i>Print Invoice Now
            </a>
        </div>
    </div>
</div>
{% endblock %}