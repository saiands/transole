{% extends 'clientdoc/base.html' %}
{% load crispy_forms_tags %}
{% block title %}{{ title }}{% endblock %}
{% block main_title %}{{ title }}{% endblock %}

{% block content %}
{% include 'clientdoc/includes/workflow_steps.html' %}

<div class="row">
    <div class="col-lg-8 offset-lg-2">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Document Management for Invoice: <span class="badge bg-warning text-dark">{{
                        invoice.tally_invoice_number|default:invoice.app_invoice_number }}</span></h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <h6 class="border-bottom pb-2 mb-3">Confirmation Documents</h6>

                    <div class="mb-3">
                        <label class="form-label">Purchase Order (PO) Copy:</label>
                        {% if has_po %}
                        <div class="alert alert-success d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-check-circle me-2"></i> File uploaded: {{
                                confirmation.po_file.name|cut:'confirmation_docs/po/' }}</span>
                            <button type="submit" name="delete_po" class="btn btn-danger btn-sm"
                                onclick="return confirm('Are you sure you want to delete the PO file?')">
                                <i class="fas fa-trash-alt"></i> Remove
                            </button>
                        </div>
                        {% else %}
                        {{ form.po_file|as_crispy_field }}
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Approval Email PDF:</label>
                        {% if has_email %}
                        <div class="alert alert-success d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-check-circle me-2"></i> File uploaded: {{
                                confirmation.approval_email_file.name|cut:'confirmation_docs/email/' }}</span>
                            <button type="submit" name="delete_email" class="btn btn-danger btn-sm"
                                onclick="return confirm('Are you sure you want to delete the Approval Email file?')">
                                <i class="fas fa-trash-alt"></i> Remove
                            </button>
                        </div>
                        {% else %}
                        {{ form.approval_email_file|as_crispy_field }}
                        {% endif %}
                    </div>

                    <h6 class="border-bottom pb-2 mb-3 mt-4">Packed Images and Notes</h6>

                    {{ image_formset.management_form }}
                    <div id="image-form-list">
                        {% for form in image_formset %}
                        <div class="p-3 mb-3 border rounded image-form-row">
                            <div class="row">
                                <div class="col-md-6">{{ form.image|as_crispy_field }}</div>
                                <div class="col-md-6">{{ form.notes|as_crispy_field }}</div>
                            </div>
                            {% if form.instance.pk %}
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <a href="{{ form.instance.image.url }}" target="_blank"
                                    class="btn btn-sm btn-outline-info">View Existing Image</a>
                                <a href="{% url 'clientdoc:delete_packed_image' form.instance.id %}"
                                    class="btn btn-sm btn-danger"
                                    onclick="return confirm('Are you sure you want to delete this image?')">
                                    <i class="fas fa-trash-alt"></i> Delete Image
                                </a>
                            </div>
                            {% endif %}
                            {{ form.DELETE }}
                        </div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        <button type="button" id="add-image-btn" class="btn btn-sm btn-outline-primary"><i
                                class="fas fa-plus"></i> Add Another Image</button>
                    </div>

                    <!-- Empty Form Template (Hidden) -->
                    <div id="empty-form" style="display:none;">
                        <div class="p-3 mb-3 border rounded image-form-row">
                            <div class="row">
                                <div class="col-md-6">{{ image_formset.empty_form.image|as_crispy_field }}</div>
                                <div class="col-md-6">{{ image_formset.empty_form.notes|as_crispy_field }}</div>
                            </div>
                            <button type="button" class="btn btn-sm btn-danger mt-2 remove-form-btn">Remove</button>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4 border-top pt-3">
                        <button type="submit" name="save_notes" class="btn btn-secondary">Save Files/Notes</button>
                        <div>
                            <button type="submit" name="preview" class="btn btn-info me-2">Preview PDF</button>
                            <button type="submit" name="generate_pdf" class="btn btn-success">Generate Final
                                PDF</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addBtn = document.getElementById('add-image-btn');
        const formList = document.getElementById('image-form-list');
        const emptyForm = document.getElementById('empty-form').innerHTML;
        const totalFormsInput = document.getElementById('id_packedimage_set-TOTAL_FORMS');
        const maxForms = 15;

        addBtn.addEventListener('click', function () {
            const currentForms = document.querySelectorAll('.image-form-row').length;
            if (currentForms >= maxForms) {
                alert("Maximum of " + maxForms + " images allowed.");
                return;
            }

            const newFormIdx = parseInt(totalFormsInput.value);
            const newFormHtml = emptyForm.replace(/__prefix__/g, newFormIdx);

            const newDiv = document.createElement('div');
            newDiv.innerHTML = newFormHtml;
            formList.appendChild(newDiv.firstElementChild);

            totalFormsInput.value = newFormIdx + 1;
        });

        // Event delegation for remove buttons
        formList.addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-form-btn')) {
                e.target.closest('.image-form-row').remove();
                // Note: We don't decrement TOTAL_FORMS because Django expects gaps if we don't re-index. 
                // Ideally, we should just hide it and set DELETE=on, but for new forms (not saved yet), removing DOM is fine 
                // IF we were re-indexing. For simplicity in this specific Django formset case without a complex library,
                // we'll just let the user save. The empty forms won't validate if required fields are missing, 
                // but here fields aren't strictly required.
                // A better approach for "Remove" on new forms is to just remove the element.
            }
        });
    });
</script>
{% endblock %}